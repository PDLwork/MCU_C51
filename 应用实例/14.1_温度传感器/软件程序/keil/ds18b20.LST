C51 COMPILER V9.01   DS18B20                                                               05/08/2021 18:31:42 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN ds18b20.OBJ
COMPILER INVOKED BY: D:\Èí¼þ\keil\C51\BIN\C51.EXE ds18b20.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg51.h>
   2          
   3          #include"userdef.h"
   4          #include"lcd1602.h"
   5          #include"ds18b20.h"
   6          
   7          uchar code str1[] = {0x28,0x30,0xC5,0xB8,0x00,0x00,0x00,0x8E}; //ROM1
   8          uchar code str2[] = {0x28,0x31,0xC5,0xB8,0x00,0x00,0x00,0xB9}; //ROM2
   9          uint tvalue;//ÎÂ¶ÈÖµ
  10          bit tflag;//ÎÂ¶ÈÕý¸º±êÖ¾
  11          
  12          static void delay5us(uint i)  /*ÑÓÊ±5Î¢Ãëº¯Êý*/
  13          {
  14   1           while(i--);
  15   1      }
  16          
  17          static void ds18b20reset()     /*ds1820¸´Î»º¯Êý*/
  18          {   
  19   1          uchar x=0;
  20   1          LCE_DQ = 1;       //DQ¸´Î»
  21   1          delay5us(4);          //ÑÓÊ±
  22   1          LCE_DQ = 0;       //DQÀ­µÍ
  23   1          delay5us(100);        //¾«È·ÑÓÊ±´óÓÚ480us
  24   1          LCE_DQ = 1;       //DQÀ­¸ß
  25   1          delay5us(40); 
  26   1      }
  27          
  28          static uchar ds18b20_read()   /*¶ÁÒ»¸ö×Ö½ÚÊý¾Ý*/
  29          {
  30   1              uchar i = 0;
  31   1          uchar dat = 0;
  32   1          for (i=0;i<8;i++)
  33   1              {  
  34   2                      LCE_DQ = 0; //¸øÂö³åÐÅºÅ
  35   2                      dat>>=1;
  36   2                      LCE_DQ = 1; //¸øÂö³åÐÅºÅ
  37   2                      if(LCE_DQ)
  38   2                      dat|=0x80;
  39   2                      delay5us(10);
  40   2              }
  41   1              return(dat);
  42   1      }
  43          
  44          static void ds18b20_write(uchar dat)  /*Ð´Ò»¸ö×Ö½ÚÊý¾Ý*/
  45          { 
  46   1              uchar i=0;
  47   1          for (i=0; i<8; i++)
  48   1              {
  49   2                      LCE_DQ = 0;
  50   2              LCE_DQ = dat&0x01;
  51   2              delay5us(10);
  52   2              LCE_DQ = 1;
  53   2              dat>>=1;
  54   2          }
  55   1      }
C51 COMPILER V9.01   DS18B20                                                               05/08/2021 18:31:42 PAGE 2   

  56          
  57          static void b20_Matchrom(uchar x)  /*Æ¥ÅäROMº¯Êý*/
  58          {
  59   1          char j;
  60   1          ds18b20_write(0x55);    //·¢ËÍÆ¥ÅäROMÃüÁî
  61   1          if (x==1)
  62   1          {
  63   2              for(j=0;j<8;j++)
  64   2              ds18b20_write(str1[j]); //·¢ËÍ18B20µÄÐòÁÐºÅ£¬ÏÈ·¢ËÍµÍ×Ö½Ú 
  65   2          }
  66   1          if(x==2)
  67   1          {
  68   2                      for(j=0;j<8;j++)
  69   2              ds18b20_write(str2[j]); //·¢ËÍ18B20µÄÐòÁÐºÅ£¬ÏÈ·¢ËÍµÍ×Ö½Ú 
  70   2          }
  71   1      }
  72          
  73          extern uchar read_temp(uchar z)   /*¶ÁÈ¡ÎÂ¶ÈÖµ²¢×ª»»º¯Êý*/
  74          {
  75   1          uchar th,tl;
  76   1          float tt;
  77   1      /**********************************************************************/
  78   1          ds18b20reset();       //³õÊ¼»¯
  79   1      //  ds18b20_write(0xCC);                  //·¢ËÍSkip RomÃüÁî£¬Ìø¹ýÆ¥ÅäÖ±½Ó×ª»»ÎÂ¶È
  80   1              if(z==1)
  81   1          {
  82   2              b20_Matchrom(1);  //Æ¥ÅäROM1
  83   2          }
  84   1          if(z==2)
  85   1              {
  86   2              b20_Matchrom(2);  //Æ¥ÅäROM2
  87   2              }
  88   1              ds18b20_write(0x44);              //·¢ËÍConvert TÃüÁî£¬¿ªÊ¼×ª»»ÎÂ¶È
  89   1      /*********************************************************************/
  90   1          ds18b20reset();       //³õÊ¼»¯
  91   1          if(z==1)
  92   1          {
  93   2              b20_Matchrom(1);  //Æ¥ÅäROM1
  94   2          }
  95   1          if(z==2)
  96   1              {
  97   2              b20_Matchrom(2);  //Æ¥ÅäROM2
  98   2              }
  99   1              ds18b20_write(0x4E);              //·¢ËÍwrite scratchpadÃüÁî,Ïò18B20Ð´Èý¸ö×Ö½Ú£¬·Ö±ðÎª±¨¾¯ÉÏÏÞ¡¢ÏÂÏÞÒÔ¼°×ª»»·Ö±æÂÊÉ
             -èÖÃ
 100   1              ds18b20_write(0xFF);              //ÓÉÓÚ²»ÓÃ18B20ÄÚ²¿µÄ±¨¾¯£¬ËùÒÔ½«ÉÏÏÂÏÞÉèÖÃÎª×î¸ßÓë×îµÍ
 101   1              ds18b20_write(0x00);
 102   1              ds18b20_write(0x7F);              //ÉèÖÃ×ª»»¾«¶È¡ª¡ª1F£º9Î»¡ª¡ª¡ª¡ª3F£º10Î»¡ª¡ª¡ª¡ª5F£º11Î»¡ª¡ª¡ª¡ª7F£º12Î»¡ª¡ª
 103   1      /*************************************************************************/
 104   1          ds18b20reset();      //³õÊ¼»¯
 105   1          if(z==1)
 106   1          {
 107   2              b20_Matchrom(1);  //Æ¥ÅäROM1
 108   2          }
 109   1          if(z==2)
 110   1              {
 111   2              b20_Matchrom(2);  //Æ¥ÅäROM2
 112   2              }
 113   1              ds18b20_write(0xbe);    //¶ÁÈ¡ÎÂ¶È 
 114   1              tl = ds18b20_read();    //µÍ8Î»
 115   1              th = ds18b20_read();    //¸ß8Î»
 116   1              tvalue = th;
C51 COMPILER V9.01   DS18B20                                                               05/08/2021 18:31:42 PAGE 3   

 117   1              tvalue<<=8;
 118   1              tvalue=tvalue|tl;
 119   1              if(tvalue<0x0fff)
 120   1              tflag=0;
 121   1          else
 122   1          {
 123   2                      tvalue=~tvalue+1;  //²¹ÂëÈ¡·´¼ÓÒ»
 124   2                      tflag=1;
 125   2          }
 126   1          tt=tvalue*0.0625;      //³Ë×îÐ¡Î»µÄÈ¨Öµ×ª»»Îª10½øÖÆÊýÖµ
 127   1          tvalue=tt*100;                 //ÒªÏÔÊ¾Á½Î»Ð¡Êý£¬³Ë100ÓÃÓÚÈ¡Ä£ÌáÈ¡Êý×Ö
 128   1          return(tvalue);
 129   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    375    ----
   CONSTANT SIZE    =     16    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
